!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.CoCreateCursors=t():e.CoCreateCursors=t()}(this,function(){return o={},n.m=r=[function(e,t){function n(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}var l,s,c,u,r=document.querySelectorAll("input,textarea,[contenteditable]"),g=!1,m=["boxSizing","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","marginTop","marginRight","marginBottom","marginLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","textRendering","webkitWritingMode","textTransform","textIndent","overflowWrap"],h=30,y=function(){function t(){!function(e){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this)}var e,r,o;return e=t,o=[{key:"print",value:function(e,t){(t=t||!1)&&console.log(e)}},{key:"generateUUID",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,r=(new Date).getTime(),o=performance&&performance.now&&1e3*performance.now()||0,t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random();return 0<r?(t=(r+t)%16|0,r=Math.floor(r/16)):(t=(o+t)%16|0,o=Math.floor(o/16)),("x"==e?t:7&t|8).toString(16)});return t=null!=e?t.substr(0,e):t}}],(r=null)&&n(e.prototype,r),o&&n(e,o),t}(),o=function(e,t){Element.prototype.matches||(Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(e){for(var t=(this.document||this.ownerDocument).querySelectorAll(e),r=t.length;0<=--r&&t.item(r)!==this;);return-1<r})},b=function(e,t,r){e.getAttribute("name");if(""==(e.getAttribute("data-document_id")||""))return!1;var o=e.dataset.mirror_id;l=document.getElementById(o);e.className.indexOf("floating-label");l||((l=document.createElement("div")).id=o,l.className="mirror_color mirror_scroll mirror-width-scroll",e.insertAdjacentElement("afterend",l));var n=e.offsetWidth-e.scrollWidth;c=l.style,s=getComputedStyle(e),u=getComputedStyle(e.parentElement);parseInt(s.marginTop),parseInt(s.marginLeft);"INPUT"!==e.nodeName?(c.wordWrap="break-word",c.whiteSpace="pre-wrap"):c.whiteSpace="pre",c.position="absolute";var i=e.getBoundingClientRect();document.documentElement.scrollTop;c.top=u.top,c.left=u.left,c.width=i.width-(parseInt(s.borderLeftWidth)+parseInt(s.borderRightWidth))+"px",c.height=i.height-(parseInt(s.borderTopWidth)+parseInt(s.borderBottomWidth))+"px",c.visibility="visible",m.forEach(function(e){c[e]=s[e]}),c.overflowX="auto",c.overflowY="hidden",c.paddingRight=parseInt(c.paddingRight)+n-parseInt(s.borderRightWidth)+"px";var a=l.querySelectorAll(".cursor-container"),d=l.querySelectorAll(".selectors_by_users"),o=-1==["TEXTAREA","INPUT"].indexOf(e.nodeName)?e.innerHTML:e.value;l.textContent=o.substring(0,t),"INPUT"===e.nodeName&&(l.textContent=l.textContent.replace(/\s/g,"Â "));n=document.createElement("span");n.id=e.nodeName+"span_selections";t=o.substring(t,r)||"";n.textContent=t,l.appendChild(n),a&&a.forEach(function(e,t,r){l.appendChild(e)}),d&&d.forEach(function(e,t,r){l.appendChild(e)});o=o.substring(r)||"",r=document.createElement("span");l.appendChild(r),r.textContent=o;i=e.getBoundingClientRect();return{start:{top:n.offsetTop,left:n.offsetLeft},end:{top:r.offsetTop,left:r.offsetLeft}}};function i(e){y.print(["draw Cursor ",e],g);var t,r,o,n,i,a,d,l,s,c,u,m,f,p=e.element;p.dataset.cursors&&!p.dataset.mirror_id||(t=e.startPosition,c=e.endPositon,r=e.clientId,""!=(m=p.getAttribute("data-document_id")||"")&&(y.print("action document_id "+m,g),void 0!==p.dataset.mirror_id&&""!=p.dataset.mirror_id||(p.dataset.mirror_id=y.generateUUID(h)),(l=b(p,t,c))&&(p.getAttribute("name"),o=p.dataset.mirror_id,s=document.getElementById(o),d=a=!1,n="_"+o,i=!(void 0===e||!e.hasOwnProperty("user"))&&e.user,m=!(void 0===e||!e.hasOwnProperty("user_id"))&&i.user_id,r&&(cursores_other_elements=document.querySelectorAll("#socket_"+r+n),cursores_other_elements.forEach(function(e,t,r){e.parentElement.getAttribute("id")!=o&&(y.print("remove old cursor others elements",g),e.remove())}),!(a=s.querySelector(".cursor-container#socket_"+r+n))&&e.hasOwnProperty("user")&&(i&&(y.print("Create Cursor",g),u='<div style="color:blue;" class="cursor-container"                                                   id="socket_'+r+n+'"                                                   ><div class="cursor"                                                   style="background-color:'+i.color+'"></div>                                                  <div class="cursor-flag" data-collection="users"                                                   name="name"                                                   data-user_name="'+i.name+'"                                                   data-user_color="'+i.color+'"                                                   data-socket_id="'+r+'"                                                   data-id_mirror="'+o+'"                                                   data-document_id="'+m+'"                                                   style="background-color:'+i.color+'"                                                   flag>'+i.name+"</div></div>",s.innerHTML=u+s.innerHTML),m&&CoCreate.crud.readDocument({collection:"users",document_id:m})),a=s.querySelector(".cursor-container#socket_"+r+n)),a&&(y.print(["Update Cursor",a,l],g),u=p,m="font-size",m=f=window.getComputedStyle?document.defaultView.getComputedStyle(u,null).getPropertyValue(m):f,f=112.5*(m=parseFloat(m.substring(0,m.length-2)))/100,m=a.querySelector(".cursor"),a.dataset.start=t,a.dataset.end=c,a.dataset.socket_id=r,a.style.top=l.end.top+"px",a.style.width="2px",m.style.height=f+"px",a.style.left=l.end.left+"px",d=document.getElementById("sel-"+r+n),t!=c&&i?((d=document.getElementById("sel-"+r+n))&&d.remove(),f=p.offsetWidth-p.scrollWidth,a=parseInt(getComputedStyle(p).paddingRight),(d=document.createElement("span")).id="sel-"+r+n,d.className="selectors_by_users",l=getComputedStyle(s),d.style.position="absolute",d.style.top=l.paddingTop,d.style.left=l.paddingLeft,d.style["padding-right"]=f+a+"px",s.insertBefore(d,s.firstChild),(s=document.createElement("span")).id="selection-"+r+n,s.style.backgroundColor=i.color,p=-1==["TEXTAREA","INPUT"].indexOf(p.nodeName)?p.innerHTML:p.value,d.textContent=p.substring(0,t),c=p.substring(t,c)||"",s.textContent=c,d.appendChild(s)):d&&d.remove()))))}function a(n){var e=n.getAttribute("data-document_id")||"";""!=e&&(name=n.getAttribute("name"),n.dataset.mirror_id&&(id_mirror=n.dataset.mirror_id,mi_mirror=document.getElementById(id_mirror),y.print(["refresh_mirror ",mi_mirror],g),selector_element=n.nodeName+"[name='"+name+"'][data-document_id='"+e+"']",y.print(["selector -> "+selector_element],g),mi_mirror&&(s=getComputedStyle(n),(c=mi_mirror.style).width=n.offsetWidth-(parseInt(s.borderLeftWidth)+parseInt(s.borderRightWidth))+"px",c.height=n.offsetHeight-(parseInt(s.borderTopWidth)+parseInt(s.borderBottomWidth))+"px",cursor_container=mi_mirror.querySelectorAll(".cursor-container"),cursor_container.forEach(function(e,t,r){var o=e.querySelector(".cursor-flag").dataset,e=e.dataset;i({element:n,startPosition:e.start,endPositon:e.end,clientId:e.socket_id,user:{color:o.user_color,name:e.user_name}})}))))}function d(n){var e=o(n,"form"),t=n.hasAttribute("data-realtime")?n.getAttribute("data-realtime"):"true";!("true"==t||e&&"true"==e.getAttribute("data-realtime"))||"false"!=t&&(y.print(["Init Events ",n],g),n.addEventListener("scroll",function(){y.print(["Move Scroll ",n],!0);n.getAttribute("name"),n.getAttribute("data-document_id");var e=n.dataset.mirror_id,e=document.getElementById(e);e&&e.scrollTo(n.scrollLeft,n.scrollTop)},!1),new ResizeObserver(function(){r.forEach(function(e,t,r){e.getAttribute("name");var o=n.dataset.mirror_id;y.print(["Resize id_mirror -> "+o],g);o=document.getElementById(o);o&&(o.style.width=e.offsetWidth+"px",o.style.height=e.offsetHeight+"px",document.activeElement===n&&b(n,n.selectionStart,n.selectionEnd),a(n))})}).observe(n),n.addEventListener("mousemove",function(e){n.getAttribute("name"),n.getAttribute("data-document_id");var t=n.dataset.mirror_id,t=document.getElementById(t);t&&t.scrollTo(n.scrollLeft,n.scrollTop)}),n.addEventListener("focusout",function(e){n.getAttribute("name"),n.getAttribute("data-document_id");var t=n.dataset.mirror_id,t=document.getElementById(t);t&&t.scrollTo(n.scrollLeft,n.scrollTop)}),n.addEventListener("keydown",function(e){n.getAttribute("name");var t=n.dataset.mirror_id,t=document.getElementById(t);t&&(t.scrollTo(n.scrollLeft,n.scrollTop),a(n))}),n.addEventListener("keyup",function(e){n.getAttribute("name");var t=n.dataset.mirror_id,t=document.getElementById(t);t&&t.scrollTo(n.scrollLeft,n.scrollTop)}))}CoCreate.socket.listen("readDocument",function(e){cursor=document.querySelector('.cursor-flag[data-document_id="'+e.document_id+'"]'),cursor&&(cursor.innerHTML=e.result[cursor.getAttribute("name")])}),Element.prototype.remove=function(){this.parentElement&&this.parentElement.removeChild(this)};window.addEventListener("resize",function(e){document.querySelectorAll("[data-mirror_id]").forEach(function(e,t,r){a(e)})},!0),document.addEventListener("scroll",function(e){document.querySelectorAll("[data-mirror_id]").forEach(function(e,t,r){a(e)})},!0),g&&console.log("elements to INIT -> ",r),r.forEach(function(e,t,r){d(e)}),CoCreateObserver.add({name:"CoCreateCursor",observe:["subtree","childList"],include:"[data-collection][data-document_id][name][data-realtime=true]",task:function(e){(e=(e=e.target)||window).querySelectorAll&&e.querySelectorAll("[data-realtime=true]").forEach(function(e){d(e)})}})}],n.c=o,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(r,o,function(e){return t[e]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0).default;function n(e){if(o[e])return o[e].exports;var t=o[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,n),t.l=!0,t.exports}var r,o});