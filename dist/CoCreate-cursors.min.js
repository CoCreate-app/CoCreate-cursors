!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.cursors=t():(e.CoCreate=e.CoCreate||{},e.CoCreate.cursors=t())}(this,function(){return o={},n.m=r=[function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t){function o(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}e.exports=function(e,t,r){return t&&o(e.prototype,t),r&&o(e,r),e}},function(e,t,r){"use strict";r.r(t);var l,s,c,u,o=r(0),n=r.n(o),o=r(1),i=r.n(o),a=document.querySelectorAll("input,textarea,[contenteditable]"),g=!1,m=["boxSizing","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","marginTop","marginRight","marginBottom","marginLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","textRendering","webkitWritingMode","textTransform","textIndent","overflowWrap"],h=30,y=function(){function e(){n()(this,e)}return i()(e,null,[{key:"print",value:function(e,t){(t=t||!1)&&console.log(e)}},{key:"generateUUID",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,r=(new Date).getTime(),o=performance&&performance.now&&1e3*performance.now()||0,t="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random();return 0<r?(t=(r+t)%16|0,r=Math.floor(r/16)):(t=(o+t)%16|0,o=Math.floor(o/16)),("x"==e?t:7&t|8).toString(16)});return t=null!=e?t.substr(0,e):t}}]),e}(),d=function(e,t){Element.prototype.matches||(Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(e){for(var t=(this.document||this.ownerDocument).querySelectorAll(e),r=t.length;0<=--r&&t.item(r)!==this;);return-1<r})},b=function(e,t,r){e.getAttribute("name");if(""==(e.getAttribute("data-document_id")||""))return!1;var o=e.dataset.mirror_id;l=document.getElementById(o);e.className.indexOf("floating-label");l||((l=document.createElement("div")).id=o,l.className="mirror_color mirror_scroll mirror-width-scroll",e.insertAdjacentElement("afterend",l));var n=e.offsetWidth-e.scrollWidth;c=l.style,s=getComputedStyle(e),u=getComputedStyle(e.parentElement);parseInt(s.marginTop),parseInt(s.marginLeft);"INPUT"!==e.nodeName?(c.wordWrap="break-word",c.whiteSpace="pre-wrap"):c.whiteSpace="pre",c.position="absolute";var i=e.getBoundingClientRect();document.documentElement.scrollTop;c.top=u.top,c.left=u.left,c.width=i.width-(parseInt(s.borderLeftWidth)+parseInt(s.borderRightWidth))+"px",c.height=i.height-(parseInt(s.borderTopWidth)+parseInt(s.borderBottomWidth))+"px",c.visibility="visible",m.forEach(function(e){-1===["left","top"].indexOf(e.toLowerCase())&&(c[e]=s[e])}),c.overflowX="auto",c.overflowY="hidden",c.paddingRight=parseInt(c.paddingRight)+n-parseInt(s.borderRightWidth)+"px";var a=l.querySelectorAll(".cursor-container"),d=l.querySelectorAll(".selectors_by_users"),o=-1==["TEXTAREA","INPUT"].indexOf(e.nodeName)?e.innerHTML:e.value;l.textContent=o.substring(0,t),"INPUT"===e.nodeName&&(l.textContent=l.textContent.replace(/\s/g,"Â "));n=document.createElement("span");n.id=e.nodeName+"span_selections";t=o.substring(t,r)||"";n.textContent=t,l.appendChild(n),a&&a.forEach(function(e,t,r){l.appendChild(e)}),d&&d.forEach(function(e,t,r){l.appendChild(e)});o=o.substring(r)||"",r=document.createElement("span");l.appendChild(r),r.textContent=o;i=e.getBoundingClientRect();return{start:{top:n.offsetTop,left:n.offsetLeft},end:{top:r.offsetTop,left:r.offsetLeft}}};function f(e){y.print(["draw Cursor ",e],g);var t=e.element;if(!t.dataset.cursors||t.dataset.mirror_id){var r=e.startPosition,o=e.endPositon,n=e.clientId,i=t.getAttribute("data-document_id")||"";if(""!=i){y.print("action document_id "+i,g),void 0!==t.dataset.mirror_id&&""!=t.dataset.mirror_id||(t.dataset.mirror_id=y.generateUUID(h));var a=b(t,r,o);if(!a)return!1;t.getAttribute("name");var d,l,s=t.dataset.mirror_id,c=document.getElementById(s),u=!1,m=!1,f="_"+s,p=!(void 0===e||!e.hasOwnProperty("user"))&&e.user,i=!(void 0===e||!e.hasOwnProperty("user_id"))&&p.user_id;n&&(document.querySelectorAll("#socket_"+n+f).forEach(function(e,t,r){e.parentElement.getAttribute("id")!=s&&(y.print("remove old cursor others elements",g),e.remove())}),!(u=c.querySelector(".cursor-container#socket_"+n+f))&&e.hasOwnProperty("user")&&(p&&(y.print("Create Cursor",g),d='<div style="color:blue;" class="cursor-container"                                                   id="socket_'+n+f+'"                                                   ><div class="cursor"                                                   style="background-color:'+p.color+'"></div>                                                  <div class="cursor-flag" data-collection="users"                                                   name="name"                                                   data-user_name="'+p.name+'"                                                   data-user_color="'+p.color+'"                                                   data-socket_id="'+n+'"                                                   data-id_mirror="'+s+'"                                                   data-document_id="'+i+'"                                                   style="background-color:'+p.color+'"                                                   flag>'+p.name+"</div></div>",c.innerHTML=d+c.innerHTML),i&&CoCreate.crud.readDocument({collection:"users",document_id:i})),u=c.querySelector(".cursor-container#socket_"+n+f)),u&&(y.print(["Update Cursor",u,a],g),d=t,i="font-size",i=l=window.getComputedStyle?document.defaultView.getComputedStyle(d,null).getPropertyValue(i):l,l=112.5*(i=parseFloat(i.substring(0,i.length-2)))/100,i=u.querySelector(".cursor"),u.dataset.start=r,u.dataset.end=o,u.dataset.socket_id=n,u.style.top=a.end.top+"px",u.style.width="2px",i.style.height=l+"px",u.style.left=a.end.left+"px",m=document.getElementById("sel-"+n+f),r!=o&&p?((m=document.getElementById("sel-"+n+f))&&m.remove(),l=t.offsetWidth-t.scrollWidth,u=parseInt(getComputedStyle(t).paddingRight),(m=document.createElement("span")).id="sel-"+n+f,m.className="selectors_by_users",a=getComputedStyle(c),m.style.position="absolute",m.style.top=a.paddingTop,m.style.left=a.paddingLeft,m.style["padding-right"]=l+u+"px",c.insertBefore(m,c.firstChild),(c=document.createElement("span")).id="selection-"+n+f,c.style.backgroundColor=p.color,t=-1==["TEXTAREA","INPUT"].indexOf(t.nodeName)?t.innerHTML:t.value,m.textContent=t.substring(0,r),t=t.substring(r,o)||"",console.log("Selection ",t,r,o),c.textContent=t,m.appendChild(c)):m&&m.remove())}}}function p(n){var e="",t=n.getAttribute("data-document_id")||"";""!=t&&(name=n.getAttribute("name"),n.dataset.mirror_id&&(e=n.dataset.mirror_id,e=document.getElementById(e),y.print(["refresh_mirror ",e],g),t=n.nodeName+"[name='"+name+"'][data-document_id='"+t+"']",y.print(["selector -> "+t],g),e&&(s=getComputedStyle(n),(c=e.style).width=n.offsetWidth-(parseInt(s.borderLeftWidth)+parseInt(s.borderRightWidth))+"px",c.height=n.offsetHeight-(parseInt(s.borderTopWidth)+parseInt(s.borderBottomWidth))+"px",e.querySelectorAll(".cursor-container").forEach(function(e,t,r){var o=e.querySelector(".cursor-flag").dataset,e=e.dataset;f({element:n,startPosition:e.start,endPositon:e.end,clientId:e.socket_id,user:{color:o.user_color,name:e.user_name}})}))))}function v(n){var e=d(n,"form"),t=n.hasAttribute("data-realtime")?n.getAttribute("data-realtime"):"true";!("true"==t||e&&"true"==e.getAttribute("data-realtime"))||"false"!=t&&(y.print(["Init Events ",n],g),n.addEventListener("scroll",function(){y.print(["Move Scroll ",n],!0);n.getAttribute("name"),n.getAttribute("data-document_id");var e=n.dataset.mirror_id,e=document.getElementById(e);e&&e.scrollTo(n.scrollLeft,n.scrollTop)},!1),new ResizeObserver(function(){a.forEach(function(e,t,r){e.getAttribute("name");var o=n.dataset.mirror_id;y.print(["Resize id_mirror -> "+o],g);o=document.getElementById(o);o&&(o.style.width=e.offsetWidth+"px",o.style.height=e.offsetHeight+"px",document.activeElement===n&&b(n,n.selectionStart,n.selectionEnd),p(n))})}).observe(n),n.addEventListener("mousemove",function(e){n.getAttribute("name"),n.getAttribute("data-document_id");var t=n.dataset.mirror_id,t=document.getElementById(t);t&&t.scrollTo(n.scrollLeft,n.scrollTop)}),n.addEventListener("focusout",function(e){n.getAttribute("name"),n.getAttribute("data-document_id");var t=n.dataset.mirror_id,t=document.getElementById(t);t&&t.scrollTo(n.scrollLeft,n.scrollTop)}),n.addEventListener("keydown",function(e){n.getAttribute("name");var t=n.dataset.mirror_id,t=document.getElementById(t);t&&(t.scrollTo(n.scrollLeft,n.scrollTop),p(n))}),n.addEventListener("keyup",function(e){n.getAttribute("name");var t=n.dataset.mirror_id,t=document.getElementById(t);t&&t.scrollTo(n.scrollLeft,n.scrollTop)}))}CoCreate.socket.listen("readDocument",function(e){var t=document.querySelector('.cursor-flag[data-document_id="'+e.document_id+'"]');t&&(t.innerHTML=e.result[t.getAttribute("name")])}),Element.prototype.remove=function(){this.parentElement&&this.parentElement.removeChild(this)};window.addEventListener("resize",function(e){document.querySelectorAll("[data-mirror_id]").forEach(function(e,t,r){p(e)})},!0),document.addEventListener("scroll",function(e){document.querySelectorAll("[data-mirror_id]").forEach(function(e,t,r){p(e)})},!0),g&&console.log("elements to INIT -> ",a),a.forEach(function(e,t,r){v(e)}),CoCreate.observer.init({name:"CoCreateCursor",observe:["subtree","childList"],include:"[data-collection][data-document_id][name][data-realtime=true]",callback:function(e){(e=(e=e.target)||window).querySelectorAll&&e.querySelectorAll("[data-realtime=true]").forEach(function(e){v(e)})}});o={draw_cursor:f,refresh_mirror:p,recalculate_local_cursors:function(d,l){y.print("count "+l,g);var s,c=d.hasAttribute("contenteditable")?parseInt(d.getAttribute("selection_start")):d.selectionStart,e=d.getAttribute("name")||"",e=(d.getAttribute("data-document_id"),d.getAttribute("data-collection"),d.dataset.mirror_id);(e=(e=document.getElementById(e))?e.querySelectorAll(".cursor-container"):null)&&(s=[],e.forEach(function(e,t,r){var o,n,i=parseInt(e.getAttribute("data-start")),a=e.getAttribute("data-user_name");y.print(["my_start local",c,"start cursor "+a+" = ",i],g),c<i&&-1==s.indexOf(a)&&(y.print("Es mayor",g),n=parseInt(e.getAttribute("data-end")),o=i+l,i=n+l,y.print(["pos_start",o,"pos_end",i],g),e=(n=e.querySelector(".cursor-flag").dataset).socket_id,n={element:d,startPosition:o,endPositon:i,clientId:e,user:{color:n.user_color,name:n.user_name}},y.print(["sent Draw Cursor ",n],g),f(n),s.push(a))}))}};t.default=o}],n.c=o,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(r,o,function(e){return t[e]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=2).default;function n(e){if(o[e])return o[e].exports;var t=o[e]={i:e,l:!1,exports:{}};return r[e].call(t.exports,t,t.exports,n),t.l=!0,t.exports}var r,o});