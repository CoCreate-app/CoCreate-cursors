/* CoCreateJS */
var element_multicursors=document.querySelectorAll("input,textarea"),debug=!1,enviroment_prod=!0,properties=["boxSizing","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","marginTop","marginRight","marginBottom","marginLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing","textRendering","webkitWritingMode","textTransform","textIndent","overflowWrap"],length_uuid=30;class CocreateUtils{static generateUUID(e=null){var t=(new Date).getTime(),r=performance&&performance.now&&1e3*performance.now()||0,o="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var o=16*Math.random();if(t>0){o=(t+o)%16|0;t=Math.floor(t/16)}else{o=(r+o)%16|0;r=Math.floor(r/16)}return("x"==e?o:7&o|8).toString(16)});return null!=e&&(o=o.substr(0,e)),o}}var mirrorDiv,computed,style,getParents=function(e,t){Element.prototype.matches||(Element.prototype.matches=Element.prototype.matchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector||Element.prototype.webkitMatchesSelector||function(e){for(var t=(this.document||this.ownerDocument).querySelectorAll(e),r=t.length;--r>=0&&t.item(r)!==this;);return r>-1})},getCaretCoordinates=function(e,t,r){e.getAttribute("name");if(""==(e.getAttribute("data-document_id")||""))return!1;var o=e.dataset.mirror_id;mirrorDiv=document.getElementById(o);e.className.indexOf("floating-label");mirrorDiv||((mirrorDiv=document.createElement("div")).id=o,mirrorDiv.className=enviroment_prod?"mirror_color mirror_scroll mirror-width-scroll":"mirror-width-scroll",document.body.appendChild(mirrorDiv));var n=e.offsetWidth-e.scrollWidth;style=mirrorDiv.style,computed=getComputedStyle(e);parseInt(computed.marginTop),parseInt(computed.marginLeft);"INPUT"!==e.nodeName?(style.wordWrap="break-word",style.whiteSpace="pre-wrap"):style.whiteSpace="pre",style.position="absolute";var i=e.getBoundingClientRect();let l=document.documentElement.scrollTop;style.top=i.top+l-1-(parseInt(computed.marginTop)-parseInt(computed.borderTopWidth))+"px",style.left=i.left-(parseInt(computed.marginLeft)-parseInt(computed.borderLeftWidth))+"px",style.width=i.width-(parseInt(computed.borderLeftWidth)+parseInt(computed.borderRightWidth))+"px",style.height=i.height-(parseInt(computed.borderTopWidth)+parseInt(computed.borderBottomWidth))+"px",style.visibility="visible",properties.forEach(function(e){style[e]=computed[e]}),"input"==e.nodeName.toLowerCase()?(style.overflowX="auto",style.overflowY="hidden"):style.overflow="visible",style.paddingRight=parseInt(style.paddingRight)+n-parseInt(computed.borderRightWidth)+"px";let a=mirrorDiv.querySelectorAll(".cursor-container"),s=mirrorDiv.querySelectorAll(".selectors_by_users"),d=-1==["TEXTAREA","INPUT"].indexOf(e.nodeName)?e.innerHTML:e.value;mirrorDiv.textContent=d.substring(0,t),"INPUT"===e.nodeName&&(mirrorDiv.textContent=mirrorDiv.textContent.replace(/\s/g,"Â "));var c=document.createElement("span");c.id=e.nodeName+"span_selections";let u=d.substring(t,r)||"";c.textContent=u,mirrorDiv.appendChild(c),a&&a.forEach(function(e,t,r){mirrorDiv.appendChild(e)}),s&&s.forEach(function(e,t,r){mirrorDiv.appendChild(e)});let m=d.substring(r)||"";var p=document.createElement("span");mirrorDiv.appendChild(p),p.textContent=m;i=e.getBoundingClientRect();return{start:{top:c.offsetTop,left:c.offsetLeft},end:{top:p.offsetTop,left:p.offsetLeft}}};function getStyle(e,t){if(window.getComputedStyle)var r=document.defaultView.getComputedStyle(e,null).getPropertyValue(t);return r}function getDocument(e,t){CoCreate.getDocument({collection:e,document_id:t})}function draw_cursor(e){let t=e.element;if(!t.dataset.cursors||t.dataset.mirror_id){let n=e.startPosition,i=e.endPositon,l=e.clientId,a=t.getAttribute("data-document_id")||"";if(""!=a){debug&&console.log("action document_id "+a),void 0!==t.dataset.mirror_id&&""!=t.dataset.mirror_id||(t.dataset.mirror_id=CocreateUtils.generateUUID(length_uuid));let s=getCaretCoordinates(t,n,i);if(!s)return!1;t.getAttribute("name");let d=t.dataset.mirror_id,c=document.getElementById(d),u=!1,m=!1,p="_"+d,g=!(void 0===e||!e.hasOwnProperty("user"))&&e.user,f=!(void 0===e||!e.hasOwnProperty("user_id"))&&g.user_id;if(l){if(cursores_other_elements=document.querySelectorAll("#socket_"+l+p),cursores_other_elements.forEach(function(e,t,r){e.parentElement.getAttribute("id")!=d&&e.remove()}),!(u=c.querySelector(".cursor-container#socket_"+l+p))&&e.hasOwnProperty("user")){if(g){let e='<div style="color:blue;" class="cursor-container"                                                   id="socket_'+l+p+'"                                                   ><div class="cursor"                                                   style="background-color:'+g.color+'"></div>                                                  <div class="cursor-flag" data-collection="users"                                                   name="name"                                                   data-user_name="'+g.name+'"                                                   data-user_color="'+g.color+'"                                                   data-socket_id="'+l+'"                                                   data-id_mirror="'+d+'"                                                   data-document_id="'+f+'"                                                   style="background-color:'+g.color+'"                                                   flag>'+g.name+"</div></div>";c.innerHTML=e+c.innerHTML}f&&CoCreate.getDocument({collection:"users",document_id:f})}u=c.querySelector(".cursor-container#socket_"+l+p)}if(u){let e=getStyle(t,"font-size"),a=112.5*(e=parseFloat(e.substring(0,e.length-2)))/100,d=u.querySelector(".cursor");if(u.dataset.start=n,u.dataset.end=i,u.dataset.socket_id=l,u.dataset.user_name=l,u.style.top=s.end.top+"px",u.style.width="2px",d.style.height=a+"px",u.style.left=s.end.left+"px",m=document.getElementById("sel-"+l+p),n!=i&&g){(m=document.getElementById("sel-"+l+p))&&m.remove();var r=t.offsetWidth-t.scrollWidth,o=parseInt(getComputedStyle(t).paddingRight);(m=document.createElement("span")).id="sel-"+l+p,m.className="selectors_by_users";let e=getComputedStyle(c);m.style.position="absolute",m.style.top=e.paddingTop,m.style.left=e.paddingLeft,m.style["padding-right"]=r+o+"px",c.insertBefore(m,c.firstChild);let a=document.createElement("span");a.id="selection-"+l+p,a.style.backgroundColor=g.color;let s=-1==["TEXTAREA","INPUT"].indexOf(t.nodeName)?t.innerHTML:t.value;m.textContent=s.substring(0,n);let d=s.substring(n,i)||"";a.textContent=d,m.appendChild(a)}else m&&m.remove()}}}}function refresh_mirror(e){let t=e.getAttribute("data-document_id")||"";""!=t&&(name=e.getAttribute("name"),id_mirror=t+name+"--mirror-div",mi_mirror=document.getElementById(id_mirror),selector_element=e.nodeName+"[name='"+name+"'][data-document_id='"+t+"']",debug&&console.log("selector -> "+selector_element),mi_mirror&&(computed=getComputedStyle(e),(style=mi_mirror.style).width=e.offsetWidth-(parseInt(computed.borderLeftWidth)+parseInt(computed.borderRightWidth))+"px",style.height=e.offsetHeight-(parseInt(computed.borderTopWidth)+parseInt(computed.borderBottomWidth))+"px",cursor_container=mi_mirror.querySelectorAll(".cursor-container"),cursor_container.forEach(function(t,r,o){let n=t.dataset;draw_cursor({element:e,startPosition:n.start,endPositon:n.end,clientId:n.socket_id,user:{color:n.user_color,name:n.user_name}})})))}function recalculate_local_cursors(e,t){let r=e.selectionStart,o=e.getAttribute("name")||"",n=e.getAttribute("data-document_id")||"",i=(e.getAttribute("data-collection"),e.dataset.mirror_id),l=document.getElementById(i).querySelectorAll(".cursor-container");l&&l.forEach(function(o,n,i){let l=parseInt(o.getAttribute("data-start"));if(debug&&console.log("my_start ",r,"start",l),l>r){let r=parseInt(o.getAttribute("data-end")),n=l+t,i=r+t;debug&&console.log("pos_start",n,"pos_end",i);let a=o.querySelector(".cursor-flag").dataset,s=a.socket_id;draw_cursor({element:e,startPosition:n,endPositon:i,clientId:s,user:{color:a.user_color,name:a.user_name}})}})}function initCursorEl(e){let t=getParents(e,"form");if(debug&&console.log(e.getAttribute("data-realtime")),"true"==e.getAttribute("data-realtime")||t&&"true"==t.getAttribute("data-realtime")){if("false"==e.getAttribute("data-realtime"))return!1;if(e.addEventListener("input",function(t){let r=e.selectionStart,o=e.selectionEnd,n=(getCaretCoordinates(e,r,o),0);switch(t.inputType){case"insertText":n=1;break;case"insertFromPaste":break;case"deleteContentBackward":n=-1}n&&recalculate_local_cursors(this,n)},!1),"TEXTAREA"==e.nodeName){e.addEventListener("scroll",function(){e.getAttribute("name"),e.getAttribute("data-document_id");let t=e.dataset.mirror_id,r=document.getElementById(t);r&&r.scrollTo(e.scrollLeft,e.scrollTop)},!1),new ResizeObserver(function(){element_multicursors.forEach(function(t,r,o){t.getAttribute("name");let n=e.dataset.mirror_id,i=document.getElementById(n);i&&(i.style.width=t.offsetWidth+"px",i.style.height=t.offsetHeight+"px",document.activeElement,document.activeElement,refresh_mirror(e),console.log(" REsize"))})}).observe(e)}else e.addEventListener("mousemove",function(t){e.getAttribute("name"),e.getAttribute("data-document_id");let r=e.dataset.mirror_id,o=document.getElementById(r);o&&o.scrollTo(e.scrollLeft,e.scrollTop)}),e.addEventListener("focusout",function(t){e.getAttribute("name"),e.getAttribute("data-document_id");let r=e.dataset.mirror_id,o=document.getElementById(r);o&&o.scrollTo(e.scrollLeft,e.scrollTop)}),e.addEventListener("keyup",function(t){e.getAttribute("name");let r=e.dataset.mirror_id,o=document.getElementById(r);o&&o.scrollTo(e.scrollLeft,e.scrollTop)})}}CoCreateSocket.listen("getDocument",function(e){cursor=document.querySelector('.cursor-flag[data-document_id="'+e.document_id+'"]'),cursor&&(cursor.innerHTML=e.result[cursor.getAttribute("name")])}),Element.prototype.remove=function(){this.parentElement&&this.parentElement.removeChild(this)};var initialize_multicursor=function(e){e.forEach(function(e,t,r){initCursorEl(e)})};function initCursorElements(e){let t=e||window;t.querySelectorAll&&t.querySelectorAll("[data-realtime=true]").forEach(e=>{initCursorEl(e)})}debug&&console.log("elements to INIT -> ",element_multicursors),initialize_multicursor(element_multicursors),CoCreateInit.register("CoCreateCursor",window,initCursorElements);